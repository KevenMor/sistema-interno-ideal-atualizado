# üîÑ Migra√ß√£o Frontend ‚Üí Backend

## üìã Resumo da Migra√ß√£o

Seu sistema atual usa **localStorage** (frontend). Agora voc√™ tem um **backend seguro** com banco de dados MySQL.

---

## üöÄ Como Configurar

### **1. Instalar Backend**

```bash
# Navegar para pasta do backend
cd backend

# Instalar depend√™ncias
npm install

# Configurar banco de dados (.env)
cp env.example .env
# Editar .env com suas configura√ß√µes MySQL

# Criar tabelas
npm run migrate

# Iniciar servidor
npm run dev
```

### **2. Verificar se Funcionou**

```bash
# Testar API
curl http://localhost:3001/api/health

# Fazer login de teste
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@autoescolaideal.com",
    "password": "admin123",
    "unit": "administrador"
  }'
```

---

## üîß Modifica√ß√µes no Frontend

### **1. Substituir UserManager (script.js)**

**‚ùå ANTES (localStorage):**
```javascript
class UserManager {
    constructor() {
        this.users = JSON.parse(localStorage.getItem('sistemaUsers')) || [];
    }
    
    validateUser(email, password, unit) {
        // Valida√ß√£o local...
    }
}
```

**‚úÖ DEPOIS (API):**
```javascript
class UserManager {
    constructor() {
        this.apiUrl = 'http://localhost:3001/api';
        this.token = localStorage.getItem('authToken');
    }
    
    async validateUser(email, password, unit) {
        try {
            const response = await fetch(`${this.apiUrl}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, unit })
            });
            
            const data = await response.json();
            
            if (data.success) {
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('currentUser', JSON.stringify(data.user));
                this.token = data.token;
                return { success: true, user: data.user, isAdmin: data.isAdmin };
            }
            
            return { success: false, message: data.message };
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o com servidor' };
        }
    }
    
    async createUser(userData) {
        try {
            const response = await fetch(`${this.apiUrl}/users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`
                },
                body: JSON.stringify(userData)
            });
            
            return await response.json();
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o' };
        }
    }
    
    async getUsers(filters = {}) {
        try {
            const params = new URLSearchParams(filters);
            const response = await fetch(`${this.apiUrl}/users?${params}`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            
            return await response.json();
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o' };
        }
    }
    
    async updateUser(userId, updateData) {
        try {
            const response = await fetch(`${this.apiUrl}/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`
                },
                body: JSON.stringify(updateData)
            });
            
            return await response.json();
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o' };
        }
    }
    
    async deleteUser(userId) {
        try {
            const response = await fetch(`${this.apiUrl}/users/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            
            return await response.json();
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o' };
        }
    }
    
    async resetPassword(userId, newPassword) {
        try {
            const response = await fetch(`${this.apiUrl}/users/${userId}/reset-password`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.token}`
                },
                body: JSON.stringify({ password: newPassword })
            });
            
            return await response.json();
        } catch (error) {
            return { success: false, message: 'Erro de conex√£o' };
        }
    }
}
```

### **2. Modificar Login (login.html)**

**‚ùå ANTES:**
```javascript
function realizarLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const unit = document.getElementById('unidade').value;
    
    const result = userManager.validateUser(email, password, unit);
    // ... resto do c√≥digo
}
```

**‚úÖ DEPOIS:**
```javascript
async function realizarLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const unit = document.getElementById('unidade').value;
    
    // Mostrar loading
    const loginBtn = document.querySelector('.login-btn');
    loginBtn.textContent = 'Entrando...';
    loginBtn.disabled = true;
    
    try {
        const result = await userManager.validateUser(email, password, unit);
        
        if (result.success) {
            showToast('Login realizado com sucesso!', 'success');
            
            // Salvar dados do usu√°rio
            localStorage.setItem('selectedUnit', unit);
            localStorage.setItem('userEmail', email);
            localStorage.setItem('isAdmin', result.isAdmin);
            
            // Redirecionar
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        } else {
            showToast(result.message || 'Erro no login', 'error');
        }
    } catch (error) {
        showToast('Erro de conex√£o com o servidor', 'error');
    } finally {
        loginBtn.textContent = 'Entrar';
        loginBtn.disabled = false;
    }
}
```

### **3. Modificar Gest√£o de Usu√°rios**

**‚ùå ANTES:**
```javascript
async function carregarUsuarios() {
    const users = userManager.getUsers();
    // ... renderizar lista
}

async function criarUsuario() {
    const userData = getFormData();
    const result = userManager.createUser(userData);
    // ... processar resultado
}
```

**‚úÖ DEPOIS:**
```javascript
async function carregarUsuarios() {
    try {
        const response = await userManager.getUsers();
        
        if (response.success) {
            renderizarListaUsuarios(response.data);
        } else {
            showToast('Erro ao carregar usu√°rios', 'error');
        }
    } catch (error) {
        showToast('Erro de conex√£o', 'error');
    }
}

async function criarUsuario() {
    const userData = getFormData();
    
    try {
        const result = await userManager.createUser(userData);
        
        if (result.success) {
            showToast('Usu√°rio criado com sucesso!', 'success');
            fecharModalUsuario();
            carregarUsuarios(); // Recarregar lista
        } else {
            showToast(result.message || 'Erro ao criar usu√°rio', 'error');
        }
    } catch (error) {
        showToast('Erro de conex√£o', 'error');
    }
}
```

### **4. Adicionar Verifica√ß√£o de Token**

**Adicionar no in√≠cio do script.js:**
```javascript
// Verificar se token ainda √© v√°lido
async function verificarAutenticacao() {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        window.location.href = 'login.html';
        return false;
    }
    
    try {
        const response = await fetch('http://localhost:3001/api/auth/verify', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            localStorage.clear();
            window.location.href = 'login.html';
            return false;
        }
        
        const data = await response.json();
        if (!data.success) {
            localStorage.clear();
            window.location.href = 'login.html';
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        localStorage.clear();
        window.location.href = 'login.html';
        return false;
    }
}

// Chamar verifica√ß√£o ao carregar p√°gina
document.addEventListener('DOMContentLoaded', async () => {
    const isAuthenticated = await verificarAutenticacao();
    if (isAuthenticated) {
        // Inicializar aplica√ß√£o
        inicializarSistema();
    }
});
```

### **5. Adicionar Interceptor para Tokens Expirados**

```javascript
// Interceptar respostas para detectar token expirado
const originalFetch = window.fetch;
window.fetch = async function(...args) {
    const response = await originalFetch.apply(this, args);
    
    if (response.status === 401) {
        const data = await response.json();
        if (data.message === 'Token expirado' || data.message === 'Token inv√°lido') {
            localStorage.clear();
            showToast('Sess√£o expirada. Fa√ßa login novamente.', 'warning');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }
    }
    
    return response;
};
```

---

## üîÑ Processo de Migra√ß√£o Gradual

### **Op√ß√£o 1: Migra√ß√£o Completa**
1. Configurar backend
2. Modificar todo o frontend
3. Testar tudo
4. Colocar em produ√ß√£o

### **Op√ß√£o 2: Migra√ß√£o Gradual**
1. Manter sistema atual funcionando
2. Configurar backend em paralelo
3. Migrar funcionalidade por funcionalidade
4. Testar cada parte
5. Substituir completamente

---

## üîí Vantagens do Backend

### **Seguran√ßa:**
- ‚úÖ Senhas criptografadas (bcrypt)
- ‚úÖ Tokens JWT seguros
- ‚úÖ Rate limiting contra ataques
- ‚úÖ Logs de auditoria completos
- ‚úÖ Valida√ß√£o robusta de dados

### **Confiabilidade:**
- ‚úÖ Dados persistentes no banco
- ‚úÖ Backup autom√°tico poss√≠vel
- ‚úÖ N√£o perde dados se limpar navegador
- ‚úÖ Controle centralizado de usu√°rios

### **Escalabilidade:**
- ‚úÖ M√∫ltiplos usu√°rios simult√¢neos
- ‚úÖ API pode ser usada por outros sistemas
- ‚úÖ F√°cil integra√ß√£o com outros servi√ßos
- ‚úÖ Monitoramento e m√©tricas

---

## üö® Pontos de Aten√ß√£o

### **1. CORS**
Se frontend e backend estiverem em dom√≠nios diferentes, configurar CORS no backend.

### **2. HTTPS em Produ√ß√£o**
Sempre usar HTTPS em produ√ß√£o para proteger tokens JWT.

### **3. Backup do Banco**
Configurar backup autom√°tico do MySQL.

### **4. Monitoramento**
Implementar logs e alertas para monitorar a API.

---

## üìû Suporte na Migra√ß√£o

Se precisar de ajuda durante a migra√ß√£o:

1. **Testar backend:** `curl http://localhost:3001/api/health`
2. **Verificar logs:** Console do servidor mostra erros
3. **Testar login:** Usar credenciais padr√£o do admin
4. **Verificar token:** Usar ferramentas como Postman

---

**üéâ Com essa migra√ß√£o, seu sistema ficar√° muito mais seguro e profissional!** 